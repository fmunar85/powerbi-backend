<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PowerBI Dashboard - CRUD DIRECTO</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: rgba(255,255,255,0.95); padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .header h1 { color: #333; text-align: center; margin-bottom: 10px; }
        .status { text-align: center; margin-bottom: 20px; }
        .status.connected { color: #28a745; }
        .status.error { color: #dc3545; }
        .section { background: rgba(255,255,255,0.95); padding: 25px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); }
        .section h2 { color: #333; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #667eea; }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-group { flex: 1; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; transition: border-color 0.3s; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: #667eea; }
        .btn { background: #667eea; color: white; border: none; padding: 12px 25px; border-radius: 8px; font-size: 16px; cursor: pointer; transition: all 0.3s; margin: 5px; }
        .btn:hover { background: #5a6fd8; transform: translateY(-2px); }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .btn-warning { background: #ffc107; color: #000; }
        .btn-warning:hover { background: #e0a800; }
        .reportes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .reporte-card { background: #f8f9fa; padding: 20px; border-radius: 12px; border: 2px solid #e9ecef; transition: all 0.3s; }
        .reporte-card:hover { border-color: #667eea; transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .reporte-card h3 { color: #333; margin-bottom: 10px; }
        .reporte-card p { color: #666; margin-bottom: 10px; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 8px; color: white; font-weight: bold; z-index: 1000; animation: slideIn 0.3s ease; }
        .notification.success { background: #28a745; }
        .notification.error { background: #dc3545; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .loading { text-align: center; padding: 20px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .url-info { background: #e7f3ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #0066cc; }
        .stats { display: flex; justify-content: space-around; background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .stat { text-align: center; }
        .stat-number { font-size: 24px; font-weight: bold; color: #667eea; }
        .stat-label { color: #666; font-size: 14px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ PowerBI Dashboard - CRUD SQL Server</h1>
            <div class="url-info">
                <strong>üåê Backend:</strong> https://powerbi-backend-vxjd.onrender.com<br>
                <strong>üìä Base de Datos:</strong> SQL Server 192.168.30.36 (Modo H√≠brido)
            </div>
            <div id="connectionStatus" class="status">üîç Verificando conexi√≥n...</div>
        </div>

        <div class="section">
            <div class="stats">
                <div class="stat">
                    <div class="stat-number" id="totalReportes">-</div>
                    <div class="stat-label">Total Reportes</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="reportesActivos">-</div>
                    <div class="stat-label">Activos</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="ultimaActualizacion">-</div>
                    <div class="stat-label">√öltima Actualizaci√≥n</div>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>‚ûï Agregar Nuevo Reporte</h2>
            <form id="addForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="titulo">T√≠tulo del Reporte:</label>
                        <input type="text" id="titulo" placeholder="Ej: Dashboard Ventas Q1 2025" required>
                    </div>
                    <div class="form-group">
                        <label for="mail">Email Responsable:</label>
                        <input type="email" id="mail" placeholder="responsable@empresa.com" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="permisos">Permisos:</label>
                        <select id="permisos">
                            <option value="admin">Admin</option>
                            <option value="financiero">Financiero</option>
                            <option value="usuario">Usuario</option>
                            <option value="lectura">Solo Lectura</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="submit" class="btn btn-success">‚ûï Agregar Reporte</button>
                    </div>
                </div>
            </form>
        </div>

        <div class="section">
            <h2>üìä Reportes en Base de Datos</h2>
            <button onclick="cargarReportes()" class="btn">üîÑ Actualizar Lista</button>
            <button onclick="exportarReportes()" class="btn" style="background: #17a2b8;">üì• Exportar JSON</button>
            <div id="loadingReportes" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Cargando reportes desde SQL Server...</p>
            </div>
            <div id="reportesContainer" class="reportes-grid"></div>
        </div>
    </div>

    <script>
        const API_URL = 'https://powerbi-backend-vxjd.onrender.com';
        let reportes = [];

        // Funci√≥n para mostrar notificaciones
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // Funci√≥n para verificar conexi√≥n
        async function verificarConexion() {
            try {
                const response = await fetch(`${API_URL}/health`);
                const data = await response.json();
                
                document.getElementById('connectionStatus').innerHTML = `‚úÖ Conectado - ${data.status} (Modo: ${data.mode})`;
                document.getElementById('connectionStatus').className = 'status connected';
                
                return true;
            } catch (error) {
                document.getElementById('connectionStatus').innerHTML = `‚ùå Sin conexi√≥n - ${error.message}`;
                document.getElementById('connectionStatus').className = 'status error';
                return false;
            }
        }

        // Funci√≥n para actualizar estad√≠sticas
        function actualizarEstadisticas() {
            const total = reportes.length;
            const activos = reportes.filter(r => r.activo === 1).length;
            const ahora = new Date().toLocaleTimeString();
            
            document.getElementById('totalReportes').textContent = total;
            document.getElementById('reportesActivos').textContent = activos;
            document.getElementById('ultimaActualizacion').textContent = ahora;
        }

        // Funci√≥n para cargar reportes
        async function cargarReportes() {
            document.getElementById('loadingReportes').style.display = 'block';
            document.getElementById('reportesContainer').innerHTML = '';
            
            try {
                const response = await fetch(`${API_URL}/reportes`);
                reportes = await response.json();
                
                mostrarReportes();
                actualizarEstadisticas();
                showNotification(`‚úÖ ${reportes.length} reportes cargados desde BD`);
                
            } catch (error) {
                showNotification(`‚ùå Error cargando reportes: ${error.message}`, 'error');
            } finally {
                document.getElementById('loadingReportes').style.display = 'none';
            }
        }

        // Funci√≥n para mostrar reportes
        function mostrarReportes() {
            const container = document.getElementById('reportesContainer');
            container.innerHTML = '';
            
            if (reportes.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">No hay reportes en la base de datos</p>';
                return;
            }
            
            reportes.forEach(reporte => {
                const card = document.createElement('div');
                card.className = 'reporte-card';
                card.innerHTML = `
                    <h3>üìä ${reporte.titulo}</h3>
                    <p><strong>üìß Email:</strong> ${reporte.mail}</p>
                    <p><strong>üîê Permisos:</strong> ${reporte.permisos_reportes}</p>
                    <p><strong>üÜî ID:</strong> ${reporte.id}</p>
                    <p><strong>üìÖ Creado:</strong> ${new Date(reporte.fecha_creacion).toLocaleDateString()}</p>
                    <p><strong>‚úÖ Estado:</strong> ${reporte.activo ? 'Activo' : 'Inactivo'}</p>
                    <div style="margin-top: 15px;">
                        <button onclick="editarReporte(${reporte.id})" class="btn btn-warning">‚úèÔ∏è Editar</button>
                        <button onclick="eliminarReporte(${reporte.id})" class="btn btn-danger">üóëÔ∏è Eliminar</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // Funci√≥n para agregar reporte
        async function agregarReporte(event) {
            event.preventDefault();
            
            const titulo = document.getElementById('titulo').value.trim();
            const mail = document.getElementById('mail').value.trim();
            const permisos = document.getElementById('permisos').value;
            
            if (!titulo || !mail) {
                showNotification('‚ùå Completa todos los campos', 'error');
                return;
            }
            
            const nuevoReporte = {
                titulo: titulo,
                mail: mail,
                permisos_reportes: permisos,
                activo: 1
            };
            
            try {
                const response = await fetch(`${API_URL}/reportes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(nuevoReporte)
                });
                
                if (response.ok) {
                    const resultado = await response.json();
                    showNotification(`‚úÖ Reporte creado en BD con ID: ${resultado.id}`);
                    
                    // Limpiar formulario
                    document.getElementById('addForm').reset();
                    
                    // Recargar lista
                    cargarReportes();
                } else {
                    const error = await response.json();
                    showNotification(`‚ùå Error: ${error.error}`, 'error');
                }
                
            } catch (error) {
                showNotification(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
            }
        }

        // Funci√≥n para eliminar reporte
        async function eliminarReporte(id) {
            if (!confirm(`¬øEst√°s seguro de eliminar el reporte ID: ${id}?\nEsta acci√≥n lo marcar√° como inactivo en la base de datos.`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/reportes/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showNotification(`‚úÖ Reporte ${id} eliminado de BD`);
                    cargarReportes();
                } else {
                    const error = await response.json();
                    showNotification(`‚ùå Error: ${error.error}`, 'error');
                }
                
            } catch (error) {
                showNotification(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
            }
        }

        // Funci√≥n para editar reporte
        async function editarReporte(id) {
            const reporte = reportes.find(r => r.id === id);
            if (!reporte) return;
            
            const nuevoTitulo = prompt('Nuevo t√≠tulo:', reporte.titulo);
            if (!nuevoTitulo) return;
            
            const nuevoMail = prompt('Nuevo email:', reporte.mail);
            if (!nuevoMail) return;
            
            try {
                const response = await fetch(`${API_URL}/reportes/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        titulo: nuevoTitulo,
                        mail: nuevoMail
                    })
                });
                
                if (response.ok) {
                    showNotification(`‚úÖ Reporte ${id} actualizado en BD`);
                    cargarReportes();
                } else {
                    const error = await response.json();
                    showNotification(`‚ùå Error: ${error.error}`, 'error');
                }
                
            } catch (error) {
                showNotification(`‚ùå Error de conexi√≥n: ${error.message}`, 'error');
            }
        }

        // Funci√≥n para exportar reportes
        function exportarReportes() {
            const dataStr = JSON.stringify(reportes, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `reportes_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            showNotification('‚úÖ Reportes exportados en JSON');
        }

        // Event listeners
        document.getElementById('addForm').addEventListener('submit', agregarReporte);

        // Inicializar
        window.onload = function() {
            verificarConexion();
            setTimeout(cargarReportes, 1000);
        };

        // Auto-refresh cada 30 segundos
        setInterval(() => {
            verificarConexion();
        }, 30000);
    </script>
</body>
</html>
